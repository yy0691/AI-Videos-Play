# 字幕识别语言问题修复指南

## 问题描述

用户报告字幕显示"乱七八糟的符号"，实际检查后发现是**字幕识别时使用了错误的语言参数**。

### 症状表现

- 视频是中文的，但字幕显示无意义的英文单词（如："jemenpine"、"pref"、"sft supebuyfine"）
- 字幕内容与视频内容完全不符
- 不是编码乱码（如：���、锟斤拷），而是识别结果完全错误

### 根本原因

**用英文语音识别模型识别了中文语音**（或反之），导致 Deepgram API 返回了完全错误的识别结果。

#### 🔥 主要原因：语言选择缓存 Bug

**严重 Bug：切换视频时，语言选择没有被重置！**

场景重现：
1. 用户上传**中文视频 A**，选择"中文"生成字幕 ✅
2. `selectedVideoLanguage` = `'zh'` 被缓存在组件 state 中
3. 用户切换到**英文视频 B**
4. 点击"生成字幕"时，代码检查到 `selectedVideoLanguage` 已有值（`'zh'`）
5. **不显示语言选择对话框，直接用"中文"识别英文视频** ❌
6. 结果：识别出无意义的拼音或错误单词！

#### 其他可能原因

1. 生成字幕时选择了"Auto-detect"（自动检测），但自动检测失败
2. 首次使用时误选了错误的语言
3. 没有显示语言选择对话框就使用了默认语言

## 解决方案

### 用户端：重新生成字幕

1. 在视频详情页面找到字幕区域
2. 点击"🔄 重新生成字幕"按钮（在翻译按钮旁边）
3. **关键步骤：**在弹出的语言选择对话框中，选择正确的视频语言
   - 中文视频 → 选择"中文 (Chinese)"
   - 英文视频 → 选择"English"
   - 其他语言 → 选择对应的语言
4. 等待重新生成完成（会清除旧字幕，使用正确的语言重新识别）

### 诊断工具

创建了 `scripts/check-subtitle-encoding.js` 检查工具，可以：
- 分析 IndexedDB 中存储的字幕数据
- 检测字幕中的中文/英文字符比例
- 诊断是否是语言选择错误问题
- 提供修复建议

使用方法：
```javascript
// 在浏览器开发者工具 Console 中运行
// 复制 scripts/check-subtitle-encoding.js 的内容并执行
```

## 代码修复

### 1. 🔥 修复语言选择缓存 Bug（关键修复）

**文件：**`components/VideoDetail.tsx`

**问题代码：**
```typescript
useEffect(() => {
  const url = URL.createObjectURL(video.file);
  setVideoUrl(url);
  // ... 其他状态重置
  // ❌ Bug：没有重置 selectedVideoLanguage
}, [video]);
```

**修复后：**
```typescript
useEffect(() => {
  const url = URL.createObjectURL(video.file);
  setVideoUrl(url);
  // ... 其他状态重置
  // 🔥 重要：切换视频时重置语言选择，避免用错误的语言识别新视频
  setSelectedVideoLanguage(null);
}, [video]);
```

**影响：**
- ✅ 每次切换视频时，语言选择都会被清空
- ✅ 生成字幕时会重新显示语言选择对话框
- ✅ 避免用上一个视频的语言识别新视频

### 2. 增强语言选择对话框警告

**文件：**`components/VideoDetail.tsx`

**修改内容：**
- 在语言选择对话框顶部添加了明显的警告框
- 警告内容："选择错误的语言会导致字幕识别完全错误！例如：中文视频选择'英文'会识别出无意义的英文单词。"
- 样式：琥珀色背景 + 警告图标，更醒目

### 3. 标记"自动检测"为不推荐选项

**文件：**`components/VideoDetail.tsx`

**修改内容：**
- "自动检测"按钮添加"不推荐"标签
- 边框改为琥珀色虚线，鼠标悬停时背景变为琥珀色
- 说明文字改为："⚠️ 可能识别错误导致字幕完全不准确，建议手动选择语言"
- 样式：琥珀色警告色系，与其他选项有明显区分

## 技术细节

### 语言参数传递流程

1. **用户选择**：`handleGenerateSubtitles(false, 'zh')` 
   - 参数：`'zh'`、`'en'`、`'ja'`、`'ko'`、`'es'`、`'fr'`、`'de'`、`'auto'`

2. **语言映射**：`mapLanguageCodeToName('zh')` → `'Chinese'`
   - 将简短代码转换为 Deepgram API 要求的全称

3. **传递给生成函数**：
   ```typescript
   generateResilientSubtitles({
     ...
     sourceLanguage: 'Chinese', // 映射后的完整语言名
   })
   ```

4. **Deepgram API 调用**：
   ```typescript
   normalizeLanguageCode('Chinese') → 'zh'
   params.append('language', 'zh')
   ```

### Deepgram 语言参数规范

Deepgram API 支持的语言代码：
- `zh` - Chinese（中文）
- `en` - English（英文）
- `ja` - Japanese（日语）
- `ko` - Korean（韩语）
- `es` - Spanish（西班牙语）
- `fr` - French（法语）
- `de` - German（德语）
- `ru` - Russian（俄语）
- `undefined` - Auto-detect（自动检测，不推荐）

## 预防措施

### 已实施的改进

1. ✅ 语言选择对话框增加明显警告提示
2. ✅ "自动检测"选项标记为不推荐
3. ✅ 重新生成字幕时会再次显示语言选择对话框
4. ✅ 记录用户选择的语言，避免每次都重新选择

### 建议的进一步改进

1. **语言智能推荐**
   - 分析视频文件名和元数据，推荐最可能的语言
   - 例如：文件名包含中文字符 → 推荐"中文"

2. **字幕质量检测**
   - 生成字幕后自动检查内容质量
   - 如果检测到大量无意义单词，提示可能选错了语言

3. **视觉化语言选择**
   - 添加国旗图标或更直观的语言标识
   - 使用更大的按钮和更明显的颜色区分

4. **历史记录**
   - 记录用户最常使用的语言
   - 在对话框中优先显示常用语言

## 相关问题

### Q: 为什么不默认使用"自动检测"？

A: Deepgram 的自动检测准确率不够高，特别是对于口音较重或音质不佳的视频。手动选择语言可以显著提高识别准确率。

### Q: 已经生成的错误字幕能否自动修复？

A: 不能。错误的字幕内容已经存储在数据库中，必须重新生成才能获得正确的字幕。

### Q: 如何避免用户每次都选择语言？

A: 系统会记住用户上次选择的语言（`selectedVideoLanguage` state），下次生成字幕时会自动使用相同的语言。只有在首次生成或点击"重新生成"时没有历史记录的情况下，才会显示语言选择对话框。

## 测试步骤

1. 上传一个中文视频
2. 点击"生成字幕"
3. 验证语言选择对话框是否显示警告提示
4. 故意选择"English"
5. 检查生成的字幕是否是无意义的英文单词
6. 点击"重新生成字幕"
7. 这次选择"中文 (Chinese)"
8. 验证新字幕是否正确识别了中文内容

## 总结

这不是一个编码问题或显示问题，而是**用户选择了错误的语言参数**导致的识别错误。通过优化UI提示和增加警告信息，可以有效避免用户犯同样的错误。

**关键点：**
- ✅ 问题已诊断：语言参数错误
- ✅ 解决方案已提供：重新生成并选择正确语言
- ✅ UI已优化：增加警告提示
- ✅ 工具已创建：检查脚本帮助诊断

